services:
  portal:
    build:
      context: ./portal
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:3080:80"
    networks:
      - horizonst

  app:
    build:
      context: ./backend
    env_file:
      - ./backend/.env
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=horizonst
      - DB_PASSWORD=horizonst
      - DB_NAME=horizonst
      - MQTT_USER=${MQTT_USER:-Horizon@user2024}
      - MQTT_PASS=${MQTT_PASS:-Chanel_horizon@2024}
      - MQTT_PERSISTENCE_MODE=app
      - EMQX_MGMT_HOST=emqx
      - EMQX_MGMT_PORT=18083
      - EMQX_MGMT_USERNAME=admin
      - EMQX_MGMT_PASSWORD=20025@BLELoRa
      - EMQX_MGMT_SSL=false
      - EMQX_MGMT_MAX_RETRIES=20
      - EMQX_MGMT_RETRY_INTERVAL_MS=3000
    depends_on:
      - postgres
      - emqx
      - mail
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:3000:3000"
    networks:
      - horizonst

  rfid_access:
    build:
      context: ./rfid-access-service
    env_file:
      - ./rfid-access-service/.env
    environment:
      - MQTT_HOST=emqx
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-Horizon@user2024}
      - MQTT_PASS=${MQTT_PASS:-Chanel_horizon@2024}
      - HTTP_PORT=${HTTP_PORT:-3001}
      - BASE_PATH=${BASE_PATH:-/elecnor}
      - RFID_WEB_ENABLED=${RFID_WEB_ENABLED:-1}
      - RFID_WEB_SESSION_SECRET=${RFID_WEB_SESSION_SECRET:-rfid-access-secret}
      - RFID_WEB_USERNAME=${RFID_WEB_USERNAME:-admin}
      - RFID_WEB_PASSWORD=${RFID_WEB_PASSWORD:-admin}
      - RFID_WEB_HISTORY_SIZE=${RFID_WEB_HISTORY_SIZE:-50}
      - RFID_DB_HOST=${RFID_DB_HOST:-postgres}
      - RFID_DB_PORT=${RFID_DB_PORT:-5432}
      - RFID_DB_USER=${RFID_DB_USER:-horizonst}
      - RFID_DB_PASSWORD=${RFID_DB_PASSWORD:-horizonst}
      - RFID_DB_NAME=${RFID_DB_NAME:-rfid_access}
      - RFID_DB_ADMIN_DB=${RFID_DB_ADMIN_DB:-postgres}
      - RFID_DB_SSL=${RFID_DB_SSL:-0}
    depends_on:
      - emqx
      - postgres
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:${HTTP_PORT:-3001}:${HTTP_PORT:-3001}"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:${HTTP_PORT:-3001}/health"]
      interval: 20s
      timeout: 3s
      retries: 5
    networks:
      - horizonst

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=horizonst
      - POSTGRES_PASSWORD=horizonst
      - POSTGRES_DB=horizonst
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U horizonst -d horizonst || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - horizonst

  pgadmin:
    image: dpage/pgadmin4:8.10
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@horizonst.com.es
      - PGADMIN_DEFAULT_PASSWORD=admin
    depends_on:
      - postgres
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:5050:80"
    networks:
      - horizonst

  emqx:
    image: emqx/emqx:5.5.0
    environment:
      - EMQX_NODE__NAME=emqx@127.0.0.1
      - EMQX_LISTENERS__TCP__DEFAULT__BIND=0.0.0.0:1883
      - EMQX_DASHBOARD__DEFAULT_PASSWORD=20025@BLELoRa
      - EMQX_DASHBOARD__DEFAULT_USERNAME=admin
      - EMQX_ALLOW_ANONYMOUS=false
      - EMQX_AUTH__MNESIA__USER__1__USERNAME=${MQTT_USER:-Horizon@user2024}
      - EMQX_AUTH__MNESIA__USER__1__PASSWORD=${MQTT_PASS:-Chanel_horizon@2024}
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 1883 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:18083:18083"
      - "1887:1883"
    networks:
      - horizonst

  mail:
    image: mailserver/docker-mailserver:latest
    hostname: mail
    domainname: horizonst.com.es
    container_name: mail
    env_file:
      - ./mailserver/mailserver.env
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    volumes:
      - mail_data:/var/mail
      - mail_state:/var/mail-state
      - mail_logs:/var/log/mail
      - ./mailserver/config/:/tmp/docker-mailserver/
      - ./mailserver/fail2ban/postfix.local:/etc/fail2ban/jail.d/postfix.local:ro
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "993:993"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - horizonst

  webmail:
    image: roundcube/roundcubemail:1.6.11-apache
    depends_on:
      - mail
    restart: unless-stopped
    environment:
      ROUNDCUBEMAIL_DEFAULT_HOST: "ssl://mail"
      ROUNDCUBEMAIL_DEFAULT_PORT: "993"
      ROUNDCUBEMAIL_SMTP_SERVER: "tls://mail"
      ROUNDCUBEMAIL_SMTP_PORT: "587"
      ROUNDCUBEMAIL_SMTP_USER: "%u"
      ROUNDCUBEMAIL_SMTP_PASS: "%p"
      ROUNDCUBEMAIL_REQUEST_PATH: "/webmail/"
      ROUNDCUBEMAIL_DB_TYPE: "sqlite"
      ROUNDCUBEMAIL_IMAP_CONN_OPTIONS: '{"ssl":{"verify_peer":false,"verify_peer_name":false}}'
      ROUNDCUBEMAIL_SMTP_CONN_OPTIONS: '{"ssl":{"verify_peer":false,"verify_peer_name":false}}'
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    volumes:
      - webmail_data:/var/roundcube
      - ./mailserver/roundcube/20-horizonst.php:/var/roundcube/config/20-horizonst.php:ro
    ports:
      - "127.0.0.1:8080:80"
    networks:
      - horizonst

networks:
  horizonst:
    driver: bridge

volumes:
  postgres_data:
  mail_data:
  mail_state:
  mail_logs:
  webmail_data:
