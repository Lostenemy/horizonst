services:
  portal:
    build:
      context: ./portal
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:3080:80"
    networks:
      - horizonst

  app:
    build:
      context: ./backend
    env_file:
      - ./backend/.env
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-horizonst}
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASS=${MQTT_PASS}
      - MQTT_PERSISTENCE_MODE=app
    depends_on:
      - postgres
      - vernemq
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:3000:3000"
    networks:
      - horizonst

  rfid_access:
    build:
      context: ./rfid-access-service
    env_file:
      - ./rfid-access-service/.env
    environment:
      - MQTT_HOST=vernemq
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASS=${MQTT_PASS}
      - HTTP_PORT=${HTTP_PORT:-3001}
      - BASE_PATH=${BASE_PATH:-/elecnor}
      - RFID_WEB_ENABLED=${RFID_WEB_ENABLED:-1}
      - RFID_WEB_SESSION_SECRET=${RFID_WEB_SESSION_SECRET}
      - RFID_WEB_USERNAME=${RFID_WEB_USERNAME}
      - RFID_WEB_PASSWORD=${RFID_WEB_PASSWORD}
      - RFID_WEB_HISTORY_SIZE=${RFID_WEB_HISTORY_SIZE:-50}
      - RFID_DB_HOST=${RFID_DB_HOST:-postgres}
      - RFID_DB_PORT=${RFID_DB_PORT:-5432}
      - RFID_DB_USER=${RFID_DB_USER}
      - RFID_DB_PASSWORD=${RFID_DB_PASSWORD}
      - RFID_DB_NAME=${RFID_DB_NAME}
      - RFID_DB_ADMIN_DB=${RFID_DB_ADMIN_DB:-postgres}
      - RFID_DB_SSL=${RFID_DB_SSL:-0}
    depends_on:
      - vernemq
      - postgres
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:${HTTP_PORT:-3001}:${HTTP_PORT:-3001}"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:${HTTP_PORT:-3001}/health"]
      interval: 20s
      timeout: 3s
      retries: 5
    networks:
      - horizonst

  postgres:
    image: postgres:15-alpine
    env_file:
      - ./.env
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME:-horizonst}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
      - ./db/mqtt.sql:/docker-entrypoint-initdb.d/03-mqtt.sql:ro
      - ./db/mqtt-init.sh:/docker-entrypoint-initdb.d/04-mqtt-init.sh:ro
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U horizonst -d horizonst || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - horizonst

  pgadmin:
    image: dpage/pgadmin4:8.10
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
    depends_on:
      - postgres
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:5050:80"
    networks:
      - horizonst

  vernemq:
    build:
      context: .
      dockerfile: vernemq/Dockerfile
    command: ["/vernemq/bin/vernemq", "start"]
    environment:
      - DOCKER_VERNEMQ_ACCEPT_EULA=yes
      - DOCKER_VERNEMQ_ALLOW_ANONYMOUS=off
      - DOCKER_VERNEMQ_PLUGINS__VMQ_PASSWD=off
      - DOCKER_VERNEMQ_PLUGINS__VMQ_ACL=off
      - DOCKER_VERNEMQ_PLUGINS__VMQ_DIVERSITY=on
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__SCRIPT__FILE=/vernemq/share/lua/auth/postgres.lua
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__POSTGRES__HOST=postgres
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__POSTGRES__PORT=5432
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__POSTGRES__DATABASE=${DB_NAME:-horizonst}
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__POSTGRES__USER=${DB_USER}
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__POSTGRES__PASSWORD=${DB_PASSWORD}
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__POSTGRES__PASSWORD_HASH_METHOD=bcrypt
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__AUTH_POSTGRES__ENABLED=on
      - DOCKER_VERNEMQ_VMQ_DIVERSITY__AUTH_POSTGRES__TABLE=vmq_auth_acl
    volumes:
      - vernemq_data:/vernemq/data
      - vernemq_log:/vernemq/log
      - ./vernemq/vernemq.conf:/vernemq/etc/vernemq.conf:ro
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "vmq-admin status || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    ports:
      - "1887:1883"
    networks:
      - horizonst

  cert-init:
    container_name: cert-init
    build:
      context: .
      dockerfile: Dockerfile.cert-init
    profiles:
      - dev
    environment:
      CERT_CN: ${MAIL_FQDN:-mail.horizonst.com.es}
      SSL_DIR: /tmp/docker-mailserver/ssl
    volumes:
      - ./mailserver/config:/tmp/docker-mailserver:rw
    restart: "no"

  mail:
    image: mailserver/docker-mailserver:15.1.0
    hostname: mail
    domainname: horizonst.com.es
    container_name: mail
    profiles:
      - mail
    env_file:
      - ./.env
    environment:
      - SSL_TYPE=${MAIL_SSL_TYPE:-manual}
      - SSL_CERT_PATH=${MAIL_SSL_CERT_PATH:-/tmp/docker-mailserver/ssl/mail.horizonst.com.es-cert.pem}
      - SSL_KEY_PATH=${MAIL_SSL_KEY_PATH:-/tmp/docker-mailserver/ssl/mail.horizonst.com.es-key.pem}
      - ENABLE_QUOTAS=1
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    volumes:
      - mail_data:/var/mail
      - mail_state:/var/mail-state
      - mail_dovecot:/var/lib/dovecot
      - mail_spool:/var/spool/postfix
      - mail_postfix_conf:/etc/postfix
      - mail_dovecot_conf:/etc/dovecot
      - dkim_conf:/etc/opendkim
      - mail_logs:/var/log/mail
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./mailserver/config:/tmp/docker-mailserver:rw
      - ./mailserver/postfix/postscreen_access.cidr:/etc/postfix/postscreen_access.cidr:ro
      - ./mailserver/fail2ban/postfix.local:/etc/fail2ban/jail.d/postfix.local:ro
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "993:993"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 587 && nc -z localhost 993"]
      interval: 30s
      timeout: 5s
      retries: 10
    networks:
      - horizonst

  webmail:
    image: roundcube/roundcubemail:1.6.11-apache
    profiles:
      - mail
    depends_on:
      - mail
    restart: unless-stopped
    environment:
      ROUNDCUBEMAIL_DEFAULT_HOST: "ssl://mail"
      ROUNDCUBEMAIL_DEFAULT_PORT: "993"
      ROUNDCUBEMAIL_SMTP_SERVER: "tls://mail"
      ROUNDCUBEMAIL_SMTP_PORT: "587"
      ROUNDCUBEMAIL_SMTP_USER: "%u"
      ROUNDCUBEMAIL_SMTP_PASS: "%p"
      ROUNDCUBEMAIL_REQUEST_PATH: "/webmail/"
      ROUNDCUBEMAIL_DB_TYPE: "sqlite"
      ROUNDCUBEMAIL_IMAP_CONN_OPTIONS: '{"ssl":{"verify_peer":false,"verify_peer_name":false}}'
      ROUNDCUBEMAIL_SMTP_CONN_OPTIONS: '{"ssl":{"verify_peer":false,"verify_peer_name":false}}'
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    volumes:
      - webmail_data:/var/roundcube
      - ./mailserver/roundcube/20-horizonst.php:/var/roundcube/config/20-horizonst.php:ro
    ports:
      - "127.0.0.1:8080:80"
    networks:
      - horizonst

networks:
  horizonst:
    driver: bridge

volumes:
  postgres_data:
  mail_data:
  mail_state:
  mail_dovecot:
  mail_spool:
  mail_postfix_conf:
  mail_dovecot_conf:
  mail_logs:
  dkim_conf:
  webmail_data:
  vernemq_data:
  vernemq_log:
