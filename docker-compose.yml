services:
  portal:
    build:
      context: ./portal
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:3080:80"
    networks:
      - horizonst

  app:
    build:
      context: ./backend
    env_file:
      - ./backend/.env
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=horizonst
      - DB_PASSWORD=horizonst
      - DB_NAME=horizonst
      - MQTT_USER=${MQTT_USER:-Horizon@user2024}
      - MQTT_PASS=${MQTT_PASS:-Chanel_horizon@2024}
      - MQTT_PERSISTENCE_MODE=emqx
      - EMQX_MGMT_HOST=emqx
      - EMQX_MGMT_PORT=18083
      - EMQX_MGMT_USERNAME=admin
      - EMQX_MGMT_PASSWORD=public
      - EMQX_MGMT_SSL=false
      - EMQX_MGMT_MAX_RETRIES=20
      - EMQX_MGMT_RETRY_INTERVAL_MS=3000
    depends_on:
      - postgres
      - emqx
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:3000:3000"
    networks:
      - horizonst

  rfid_access:
    build:
      context: ./rfid-access-service
    env_file:
      - ./rfid-access-service/.env
    environment:
      - MQTT_HOST=emqx
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-Horizon@user2024}
      - MQTT_PASS=${MQTT_PASS:-Chanel_horizon@2024}
      - HTTP_PORT=${HTTP_PORT:-3001}
      - BASE_PATH=${BASE_PATH:-/elecnor}
      - RFID_WEB_ENABLED=${RFID_WEB_ENABLED:-1}
      - RFID_WEB_SESSION_SECRET=${RFID_WEB_SESSION_SECRET:-rfid-access-secret}
      - RFID_WEB_USERNAME=${RFID_WEB_USERNAME:-admin}
      - RFID_WEB_PASSWORD=${RFID_WEB_PASSWORD:-admin}
      - RFID_WEB_HISTORY_SIZE=${RFID_WEB_HISTORY_SIZE:-50}
    depends_on:
      - emqx
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:${HTTP_PORT:-3001}:${HTTP_PORT:-3001}"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:${HTTP_PORT:-3001}/health"]
      interval: 20s
      timeout: 3s
      retries: 5
    networks:
      - horizonst

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=horizonst
      - POSTGRES_PASSWORD=horizonst
      - POSTGRES_DB=horizonst
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U horizonst -d horizonst || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - horizonst

  pgadmin:
    image: dpage/pgadmin4:8.10
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@horizonst.com.es
      - PGADMIN_DEFAULT_PASSWORD=admin
    depends_on:
      - postgres
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "127.0.0.1:5050:80"
    networks:
      - horizonst

  emqx:
    image: emqx/emqx:5.5.0
    environment:
      - EMQX_NODE__NAME=emqx@127.0.0.1
      - EMQX_LISTENERS__TCP__DEFAULT__BIND=0.0.0.0:1883
      - EMQX_DASHBOARD__DEFAULT_PASSWORD=public
      - EMQX_DASHBOARD__DEFAULT_USERNAME=admin
      - EMQX_ALLOW_ANONYMOUS=false
      - EMQX_AUTH__MNESIA__USER__1__USERNAME=${MQTT_USER:-Horizon@user2024}
      - EMQX_AUTH__MNESIA__USER__1__PASSWORD=${MQTT_PASS:-Chanel_horizon@2024}
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 1883 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    ports:
      - "127.0.0.1:18083:18083"
      - "1887:1883"
    networks:
      - horizonst

networks:
  horizonst:
    driver: bridge

volumes:
  postgres_data:
